

<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>PHOENIX V85 - TARGET ACQUIRED</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; }
        
        /* HUD GRAFICO */
        #hud {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            background: linear-gradient(rgba(0, 255, 0, 0.05) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(0, 255, 0, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            z-index: 10;
        }

        #interface {
            position: absolute; top: 20px; left: 20px; color: #0f0;
            text-shadow: 0 0 5px #0f0; z-index: 20;
        }

        h1 { margin: 0; font-size: 24px; border-bottom: 2px solid #0f0; display: inline-block; padding-bottom: 5px; }
        .stat { font-size: 14px; margin-top: 5px; opacity: 0.8; }
        #anomaly-alert { 
            color: red; font-weight: bold; font-size: 18px; 
            display: none; animation: blink 1s infinite; margin-top: 10px;
            text-shadow: 0 0 10px red;
        }

        @keyframes blink { 50% { opacity: 0; } }

        #scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: #0f0; opacity: 0.5;
            animation: scan 3s linear infinite;
        }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</head>
<body>
    <div id="hud">
        <div id="scan-line"></div>
    </div>

    <div id="interface">
        <h1>PHOENIX PROTOCOL V85</h1>
        <div class="stat" id="status">SYSTEM: INITIALIZING NEURAL LINK...</div>
        <div class="stat" id="coords">SECTOR: CYGNUS-X</div>
        <div class="stat" id="count">OBJECTS: SCANNING...</div>
        <div id="anomaly-alert">⚠️ ANOMALIES DETECTED ⚠️</div>
    </div>

    <script>
        // --- 1. SETUP GRAFICO AVANZATO ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.002); // Nebbia spaziale

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // Controlli Mouse
        let mouseX = 0, mouseY = 0;
        document.addEventListener('mousemove', (e) => {
            mouseX = (e.clientX - window.innerWidth / 2) * 0.1;
            mouseY = (e.clientY - window.innerHeight / 2) * 0.1;
        });

        // --- 2. GENERATORE DI UNIVERSO V85 ---
        function createGalaxy(data) {
            const geometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];
            const sizes = [];

            let anomalyCount = 0;

            data.forEach(star => {
                // Posizione
                let x, y, z;
                if(star.ra) {
                    // Mappa Reale Scalata
                    x = (star.ra - 290) * 40; 
                    y = (star.dec - 30) * 40;
                    z = (star.parallax ? (1000/star.parallax) : Math.random() * 500) - 250;
                    if (z > 500) z = 500; // Limita profondità
                    if (z < -500) z = -500;
                } else {
                    // Simulazione
                    x = star.x; y = star.y; z = star.z;
                }

                positions.push(x, y, z);

                // Logica Colore V85
                const isAnomaly = star.anomaly_score > 0.8 || star.is_anomaly;
                
                if (isAnomaly) {
                    colors.push(1.0, 0.0, 0.0); // ROSSO PURO
                    sizes.push(2.5); // Più grandi
                    anomalyCount++;
                } else {
                    // Gradiente Blu-Bianco basato sulla "temperatura" simulata
                    const r = 0.5 + Math.random() * 0.5;
                    colors.push(r, r, 1.0); 
                    sizes.push(0.5);
                }
            });

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

            // Materiale "Glowing"
            const material = new THREE.PointsMaterial({
                size: 1.0,
                vertexColors: true,
                map: getSprite(),
                blending: THREE.AdditiveBlending,
                depthTest: false,
                transparent: true
            });

            const starSystem = new THREE.Points(geometry, material);
            scene.add(starSystem);

            // Aggiorna HUD
            document.getElementById('status').innerText = "SYSTEM: ONLINE - TRACKING";
            document.getElementById('status').style.color = "#0f0";
            document.getElementById('count').innerText = "OBJECTS: " + data.length + " | ANOMALIES: " + anomalyCount;
            
            if(anomalyCount > 0) {
                document.getElementById('anomaly-alert').style.display = "block";
            }
        }

        // Texture "Glow" fatta al volo
        function getSprite() {
            const canvas = document.createElement('canvas');
            canvas.width = 32; canvas.height = 32;
            const context = canvas.getContext('2d');
            const gradient = context.createRadialGradient(16, 16, 0, 16, 16, 16);
            gradient.addColorStop(0, 'rgba(255,255,255,1)');
            gradient.addColorStop(0.2, 'rgba(255,255,255,0.8)');
            gradient.addColorStop(0.5, 'rgba(255,255,255,0.2)');
            gradient.addColorStop(1, 'rgba(0,0,0,0)');
            context.fillStyle = gradient;
            context.fillRect(0, 0, 32, 32);
            const texture = new THREE.CanvasTexture(canvas);
            return texture;
        }

        // --- 3. CARICAMENTO DATI (Con Fallback V3) ---
        const dbUrl = 'universe_db.json?v=' + Date.now(); // NO CACHE
        
        fetch(dbUrl)
            .then(res => {
                if(!res.ok) throw new Error("DB Connection Pending");
                return res.json();
            })
            .then(data => {
                console.log("Dati Reali Caricati");
                createGalaxy(data);
            })
            .catch(err => {
                console.warn("Switching to Simulation Mode");
                document.getElementById('status').innerText = "MODE: SIMULATION (DB SYNCING...)";
                document.getElementById('status').style.color = "orange";
                
                // Genera Galassia Finta Bellissima
                const fakeData = [];
                for(let i=0; i<8000; i++) {
                    const r = Math.random() * 400;
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.random() * Math.PI;
                    fakeData.push({
                        x: r * Math.sin(phi) * Math.cos(theta),
                        y: r * Math.sin(phi) * Math.sin(theta),
                        z: r * Math.cos(phi) * 0.5, // Appiattita
                        is_anomaly: Math.random() > 0.995
                    });
                }
                createGalaxy(fakeData);
            });

        // --- 4. ANIMAZIONE ---
        camera.position.z = 300;
        let time = 0;

        function animate() {
            requestAnimationFrame(animate);
            time += 0.001;

            // Rotazione Galattica
            scene.rotation.y = time * 0.5;
            scene.rotation.z = Math.sin(time * 0.2) * 0.1;

            // Movimento Camera Fluido
            camera.position.x += (mouseX - camera.position.x) * 0.05;
            camera.position.y += (-mouseY - camera.position.y) * 0.05;
            camera.lookAt(scene.position);

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
