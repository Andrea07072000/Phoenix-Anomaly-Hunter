<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>PHOENIX V100: ANOMALY HUNTER</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #000; color: #00ffaa; font-family: 'Share Tech Mono', monospace; overflow: hidden; }
        #ui { position: absolute; top: 20px; left: 20px; pointer-events: none; }
        h1 { margin: 0; font-size: 24px; text-shadow: 0 0 10px #00ffaa; }
        #stats { font-size: 12px; color: #88aa88; margin-top: 5px; }
        #tooltip { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
                   background: rgba(0,20,0,0.9); border: 1px solid #00ffaa; padding: 15px; display: none; text-align: center; }
        .anom-alert { color: #ff0000; font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>
    <div id="ui">
        <h1>PHOENIX V100</h1>
        <div id="stats">SYSTEM STATUS: WAITING FOR DATA LINK...</div>
    </div>
    <div id="tooltip"></div>

    <script>
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.00005);
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 1000000);
        camera.position.set(0, 500, 1000);
        const renderer = new THREE.WebGLRenderer({antialias:true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.2;

        const composer = new THREE.EffectComposer(renderer);
        composer.addPass(new THREE.RenderPass(scene, camera));
        composer.addPass(new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85));

        // STELLE SFONDO
        const starsGeo = new THREE.BufferGeometry();
        const starPos = [];
        for(let i=0; i<10000; i++) starPos.push((Math.random()-0.5)*100000, (Math.random()-0.5)*100000, (Math.random()-0.5)*100000);
        starsGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
        scene.add(new THREE.Points(starsGeo, new THREE.PointsMaterial({color:0xffffff, size:2})));

        const interactables = [];
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        fetch('universe_db.json').then(r => r.json()).then(data => {
            document.getElementById('stats').innerText = `MONITORING ${data.length} OBJECTS | AI ACTIVE`;
            
            data.forEach(obj => {
                const geo = new THREE.SphereGeometry(obj.r, 16, 16);
                const mat = new THREE.MeshBasicMaterial({color: obj.col});
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(obj.x, obj.y, obj.z);
                mesh.userData = obj;
                scene.add(mesh);
                interactables.push(mesh);

                // Linea verso il piano 0 (riferimento visivo)
                const lineGeo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(obj.x, obj.y, obj.z), new THREE.Vector3(obj.x, 0, obj.z)]);
                scene.add(new THREE.Line(lineGeo, new THREE.LineBasicMaterial({color: 0x222222})));
            });
        }).catch(e => {
            document.getElementById('stats').innerText = "DATA LINK FAILED - USING LOCAL MODE";
        });

        window.addEventListener('mousemove', (e) => {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(interactables);
            
            const tt = document.getElementById('tooltip');
            if(intersects.length > 0) {
                const d = intersects[0].object.userData;
                tt.style.display = 'block';
                let html = `<div style="font-size:20px; color:${d.col}">${d.n}</div>`;
                html += `<div>${d.t}</div>`;
                if(d.t.includes("ANOMALY")) html += `<div class="anom-alert">⚠️ HIGH STATISTICAL DEVIATION DETECTED</div>`;
                html += `<hr style="border:1px solid #333">`;
                for(let k in d.d) html += `<div>${k}: ${d.d[k]}</div>`;
                tt.innerHTML = html;
                document.body.style.cursor = 'pointer';
            } else {
                tt.style.display = 'none';
                document.body.style.cursor = 'default';
            }
        });

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            composer.render();
        }
        animate();
    </script>
</body>
</html>