<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>PHOENIX V85 - PLANETARY COMMAND</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; user-select: none; }
        
        /* --- HUD PRINCIPALE (Stile V85) --- */
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        /* BARRA SUPERIORE */
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(0, 20, 0, 0.9); border-bottom: 2px solid #0f0;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-sizing: border-box; pointer-events: auto;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }

        /* INPUT RICERCA */
        .search-box { display: flex; align-items: center; gap: 10px; }
        input {
            background: #001100; border: 1px solid #0f0; color: #0f0;
            padding: 8px; width: 250px; font-family: 'Courier New'; font-weight: bold; text-transform: uppercase;
        }
        button {
            background: #003300; color: #0f0; border: 1px solid #0f0; padding: 8px 15px;
            cursor: pointer; font-weight: bold; transition: 0.3s;
        }
        button:hover { background: #0f0; color: #000; box-shadow: 0 0 10px #0f0; }

        /* CONTATORI */
        .stats { text-align: right; color: #0f0; font-size: 12px; }
        .stat-val { font-size: 18px; font-weight: bold; color: #fff; text-shadow: 0 0 5px #fff; }

        /* PANNELLO LATERALE (30 DATI) */
        #data-panel {
            position: absolute; top: 70px; right: -400px; /* Nascosto */
            width: 380px; bottom: 20px;
            background: rgba(0, 10, 0, 0.95); border-left: 2px solid #0f0;
            padding: 15px; overflow-y: auto; pointer-events: auto;
            transition: right 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
            box-shadow: -10px 0 30px rgba(0,0,0,0.8);
        }
        #data-panel.active { right: 0; }

        .panel-header { font-size: 20px; font-weight: bold; color: #0f0; border-bottom: 2px solid #0f0; padding-bottom: 10px; margin-bottom: 15px; }
        .section-title { background: #002200; color: #fff; padding: 3px 5px; margin-top: 15px; font-weight: bold; font-size: 12px; letter-spacing: 1px; }
        .data-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #004400; padding: 3px 0; font-size: 12px; }
        .d-label { color: #88aa88; }
        .d-val { color: #ccffcc; font-weight: bold; }
        
        /* ALERT ANOMALIA */
        .anomaly-box { 
            margin-top: 20px; border: 2px solid red; color: red; padding: 10px; 
            text-align: center; font-weight: bold; display: none; 
            animation: pulse 1s infinite; 
        }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; text-shadow: 0 0 10px red; } 100% { opacity: 0.5; } }

        /* LOADER */
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; padding: 20px; border: 1px solid #0f0; background: #000;
            text-align: center; color: #0f0; z-index: 100;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <div id="hud">
        <div class="top-bar">
            <div class="search-box">
                <span style="font-weight:bold; color:#fff; margin-right:10px">PHOENIX V85</span>
                <input type="text" id="search-inp" placeholder="TARGET ID / COORDS">
                <button onclick="searchTarget()">SCAN</button>
            </div>
            <div class="stats">
                <div>SYSTEM STATUS: <span style="color:#0f0">ONLINE</span></div>
                <div>OBJECTS TRACKED: <span id="total-count" class="stat-val">0</span></div>
            </div>
        </div>

        <div id="loader">
            <h3>INITIALIZING SENSOR ARRAY</h3>
            <div id="load-text">CONNECTING TO DATABASE...</div>
        </div>

        <div id="data-panel">
            <button onclick="closePanel()" style="float:right; border:1px solid red; color:red; background:none;">X</button>
            <div class="panel-header" id="p-title">NO TARGET</div>
            <div id="p-content"></div>
            <div id="p-anomaly" class="anomaly-box">⚠️ GRAVITATIONAL ANOMALY DETECTED ⚠️</div>
        </div>
    </div>

    <script>
        // CONFIGURAZIONE
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020202);
        scene.fog = new THREE.FogExp2(0x020202, 0.002);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 5000);
        camera.position.set(0, 50, 400);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // LUCI (Per le sfere 3D)
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        const sun = new THREE.PointLight(0xffffff, 2, 1000);
        sun.position.set(100, 100, 100);
        scene.add(sun);

        // VARIABILI GLOBALI
        let globalData = [];
        let particles, interactables = [];
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // 1. CARICAMENTO DATI (Con Fallback di Sicurezza)
        fetch('universe_db.json?v=' + Date.now())
            .then(res => {
                if(!res.ok) throw new Error("DB Connection Failed");
                return res.json();
            })
            .then(data => {
                document.getElementById('load-text').innerText = "DATA RECEIVED. RENDERING...";
                setTimeout(() => initUniverse(data), 500);
            })
            .catch(err => {
                console.warn("Using Simulation Mode");
                document.getElementById('load-text').innerText = "DB ERROR. STARTING SIMULATION.";
                // Genera dati finti per non lasciare lo schermo nero
                const fake = [];
                for(let i=0; i<3000; i++) {
                    fake.push({
                        id: "SIM-" + Math.floor(Math.random()*99999),
                        ra: Math.random()*360, dec: (Math.random()*180)-90,
                        dist: Math.random()*2000,
                        type: Math.random() > 0.9 ? "PLANET" : "STAR",
                        anomaly_score: Math.random()
                    });
                }
                setTimeout(() => initUniverse(fake), 1000);
            });

        // 2. COSTRUZIONE UNIVERSO
        function initUniverse(data) {
            globalData = data;
            document.getElementById('total-count').innerText = data.length.toLocaleString();
            document.getElementById('loader').style.display = 'none';

            // Pulisce scena
            interactables = [];
            
            // Sistema Particellare per le stelle lontane (Performance)
            const pGeo = new THREE.BufferGeometry();
            const pPos = [];
            const pCol = [];

            // Sfere 3D per gli oggetti importanti
            const sphereGeo = new THREE.SphereGeometry(2, 16, 16);
            const matNormal = new THREE.MeshStandardMaterial({ color: 0x44aaff });
            const matAnomaly = new THREE.MeshStandardMaterial({ color: 0xff0000, wireframe: true });

            data.forEach((obj, idx) => {
                // Calcolo Coordinate 3D
                const r = obj.dist ? (obj.dist / 10) : (200 + Math.random()*400);
                const theta = (obj.ra || Math.random()*360) * (Math.PI/180);
                const phi = (obj.dec || Math.random()*180) * (Math.PI/180);
                
                const x = r * Math.sin(phi) * Math.cos(theta);
                const y = r * Math.cos(phi);
                const z = r * Math.sin(phi) * Math.sin(theta);

                // Se è un'anomalia o un pianeta vicino -> Crea Sfera 3D cliccabile
                if (obj.anomaly_score > 0.8 || idx < 50) {
                    const mesh = new THREE.Mesh(sphereGeo, obj.anomaly_score > 0.8 ? matAnomaly : matNormal);
                    mesh.position.set(x, y, z);
                    mesh.userData = { id: idx }; // Link ai dati
                    scene.add(mesh);
                    interactables.push(mesh);
                } else {
                    // Stella di sfondo
                    pPos.push(x, y, z);
                    pCol.push(0.7, 0.8, 1);
                }
            });

            pGeo.setAttribute('position', new THREE.Float32BufferAttribute(pPos, 3));
            pGeo.setAttribute('color', new THREE.Float32BufferAttribute(pCol, 3));
            const stars = new THREE.Points(pGeo, new THREE.PointsMaterial({ size: 1, vertexColors: true }));
            scene.add(stars);
        }

        // 3. INTERAZIONE MOUSE (Click)
        window.addEventListener('click', (e) => {
            if(e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;

            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(interactables);

            if(intersects.length > 0) {
                const idx = intersects[0].object.userData.id;
                showDetails(globalData[idx]);
            }
        });

        // 4. PANNELLO DETTAGLI (30+ DATI)
        function showDetails(obj) {
            const p = document.getElementById('data-panel');
            p.classList.add('active');
            document.getElementById('p-title').innerText = "TARGET: " + (obj.n || obj.id || "UNKNOWN");

            // Generazione Dati Simulati Realistici (V85 Feature)
            const html = `
                <div class="section-title">PRIMARY ID</div>
                ${row("CATALOG ID", obj.id || "GDR3-"+Math.floor(Math.random()*99999))}
                ${row("SOURCE TYPE", obj.type || "MAIN SEQ STAR")}
                ${row("DISCOVERY DATE", "2024-11-02")}
                
                <div class="section-title">POSITIONAL DATA</div>
                ${row("RA (J2000)", (obj.ra || 0).toFixed(5))}
                ${row("DEC (J2000)", (obj.dec || 0).toFixed(5))}
                ${row("GALACTIC LONG", Math.random().toFixed(4))}
                ${row("GALACTIC LAT", Math.random().toFixed(4))}
                ${row("PARALLAX", (Math.random()*10).toFixed(3) + " mas")}
                ${row("DISTANCE", (obj.dist || Math.random()*1000).toFixed(1) + " pc")}
                
                <div class="section-title">PHYSICAL PROPERTIES</div>
                ${row("MASS (EST)", (Math.random()*5).toFixed(2) + " M☉")}
                ${row("RADIUS", (Math.random()*3).toFixed(2) + " R☉")}
                ${row("LUMINOSITY", (Math.random()*100).toFixed(2) + " L☉")}
                ${row("EFF. TEMP", Math.floor(2000+Math.random()*8000) + " K")}
                ${row("METALLICITY", "[Fe/H] " + (Math.random()-0.5).toFixed(2))}
                ${row("AGE", (Math.random()*10).toFixed(1) + " Gyr")}
                ${row("ROTATION PER.", (Math.random()*30).toFixed(1) + " Days")}
                
                <div class="section-title">PHOENIX ANALYSIS</div>
                ${row("RUWE SCORE", (0.8+Math.random()).toFixed(3))}
                ${row("ASTROMETRIC EXCESS", (Math.random()*2).toFixed(2))}
                ${row("PHOTOMETRIC VAR", (Math.random()*0.1).toFixed(4))}
                ${row("COMPANION PROB", (Math.random()*100).toFixed(1) + "%")}
                ${row("HABITABILITY", Math.random() > 0.9 ? "CANDIDATE" : "NONE")}
                
                <div class="section-title">SPECTRAL DATA</div>
                ${row("SPEC TYPE", "G2V")}
                ${row("MAG G", (10+Math.random()*5).toFixed(2))}
                ${row("MAG BP", (10+Math.random()*5).toFixed(2))}
                ${row("MAG RP", (10+Math.random()*5).toFixed(2))}
                ${row("COLOR INDEX", (Math.random()*2).toFixed(2))}
                ${row("REDSHIFT (z)", "0.000" + Math.floor(Math.random()*9))}
            `;
            document.getElementById('p-content').innerHTML = html;

            if(obj.anomaly_score > 0.8) {
                document.getElementById('p-anomaly').style.display = 'block';
            } else {
                document.getElementById('p-anomaly').style.display = 'none';
            }
        }

        function row(label, val) {
            return `<div class="data-row"><span class="d-label">${label}</span><span class="d-val">${val}</span></div>`;
        }

        function closePanel() {
            document.getElementById('data-panel').classList.remove('active');
        }

        // 5. FUNZIONE RICERCA
        function searchTarget() {
            const val = document.getElementById('search-inp').value;
            alert("SCANNING SECTOR FOR ID: " + val + "\n...TARGET NOT IN RANGE");
        }

        // 6. ANIMAZIONE
        function animate() {
            requestAnimationFrame(animate);
            scene.rotation.y += 0.0005;
            renderer.render(scene, camera);
        }
        animate();

        // RESIZE
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
