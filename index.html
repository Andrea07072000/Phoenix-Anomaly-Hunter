<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Phoenix Anomaly Hunter - ULTIMATE</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; }
        #hud {
            position: absolute; top: 20px; left: 20px; z-index: 100;
            color: #0f0; text-shadow: 0 0 5px #0f0; pointer-events: none;
        }
        h1 { margin: 0; font-size: 20px; }
        .status-line { margin-top: 5px; font-size: 14px; }
        #error-box { color: #ff3333; display: none; margin-top: 10px; border: 1px solid red; padding: 5px; background: rgba(50,0,0,0.5); }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>
    <div id="hud">
        <h1>PHOENIX PROTOCOL V3</h1>
        <div class="status-line" id="status">SYSTEM: INITIALIZING...</div>
        <div class="status-line" id="count">OBJECTS: SCANNING...</div>
        <div id="error-box"></div>
    </div>

    <script>
        // 1. CONFIGURAZIONE SCENA
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Controlli orbitali semplici (Mouse)
        let mouseX = 0, mouseY = 0;
        document.addEventListener('mousemove', (event) => {
            mouseX = (event.clientX - window.innerWidth / 2) * 0.05;
            mouseY = (event.clientY - window.innerHeight / 2) * 0.05;
        });

        // 2. FUNZIONE PER GENERARE L'UNIVERSO
        function renderUniverse(data, mode) {
            // Pulisce la scena
            while(scene.children.length > 0){ 
                scene.remove(scene.children[0]); 
            }

            const geometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];

            data.forEach(star => {
                // Coordinate: Se sono dati veri usa RA/DEC, se no usa X/Y/Z simulati
                let x, y, z;
                if (mode === 'REAL') {
                    x = (star.ra - 299) * 50; // Centra su Cygnus
                    y = (star.dec - 40) * 50;
                    z = (Math.random() * 200) - 100; // ProfonditÃ  stimata
                } else {
                    x = star.x; y = star.y; z = star.z;
                }

                positions.push(x, y, z);

                // Colore
                if (star.anomaly_score > 0.8 || star.is_anomaly) {
                    colors.push(1, 0, 0); // ROSSO (Anomalia)
                } else {
                    colors.push(0.5, 0.5, 1); // BLU (Normale)
                }
            });

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({ size: 0.8, vertexColors: true });
            const points = new THREE.Points(geometry, material);
            scene.add(points);

            // Aggiorna HUD
            document.getElementById('status').innerText = "SYSTEM: ONLINE (" + mode + " MODE)";
            document.getElementById('count').innerText = "OBJECTS: " + data.length;
            if (mode === 'REAL') document.getElementById('status').style.color = '#0f0';
            else document.getElementById('status').style.color = 'orange';
        }

        // 3. LOGICA DI CARICAMENTO (Il cuore del sistema)
        const dbUrl = 'universe_db.json?v=' + Date.now(); // Cache Buster

        document.getElementById('status').innerText = "SYSTEM: CONNECTING TO DB...";

        fetch(dbUrl)
            .then(response => {
                if (!response.ok) throw new Error("Database not ready (Error " + response.status + ")");
                return response.json();
            })
            .then(data => {
                // SUCCESSO: Dati veri trovati
                console.log("Dati reali caricati.");
                renderUniverse(data, 'REAL');
            })
            .catch(error => {
                // FALLIMENTO: Attiva simulazione di emergenza
                console.warn("Errore caricamento:", error);
                document.getElementById('error-box').style.display = 'block';
                document.getElementById('error-box').innerText = "WARNING: " + error.message + ". SWITCHING TO SIMULATION.";
                
                // Genera dati finti per non lasciare lo schermo nero
                const fakeData = [];
                for(let i=0; i<5000; i++) {
                    fakeData.push({
                        x: (Math.random() - 0.5) * 800,
                        y: (Math.random() - 0.5) * 800,
                        z: (Math.random() - 0.5) * 800,
                        is_anomaly: Math.random() > 0.99
                    });
                }
                renderUniverse(fakeData, 'SIMULATION');
            });

        // 4. ANIMAZIONE LOOP
        camera.position.z = 200;
        function animate() {
            requestAnimationFrame(animate);
            
            // Rotazione lenta
            scene.rotation.y += 0.002;
            scene.rotation.x += 0.001;

            // Movimento interattivo leggero
            camera.position.x += (mouseX - camera.position.x) * 0.05;
            camera.position.y += (-mouseY - camera.position.y) * 0.05;

            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
