<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>PHOENIX V99 - MASTER CONTROL</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; user-select: none; }
        
        /* --- HUD --- */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        /* HEADER */
        .header {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(0, 20, 0, 0.95); border-bottom: 2px solid #00ff00;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-sizing: border-box; pointer-events: auto;
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
        }

        /* RICERCA */
        .search-box { display: flex; gap: 5px; }
        input {
            background: #001100; border: 1px solid #00ff00; color: #00ff00;
            padding: 5px 10px; font-family: 'Courier New'; font-weight: bold; width: 200px;
            text-transform: uppercase;
        }
        button {
            background: #004400; color: #00ff00; border: 1px solid #00ff00;
            cursor: pointer; font-weight: bold; padding: 5px 15px;
        }
        button:hover { background: #00ff00; color: #000; }

        /* COUNTER (QUELLO CHE VOLEVI) */
        .stats-box { text-align: right; color: #00ff00; font-size: 12px; }
        #obj-counter { font-size: 20px; font-weight: bold; color: #fff; text-shadow: 0 0 5px #fff; }

        /* PANNELLO LATERALE */
        #data-panel {
            position: absolute; top: 80px; right: -400px; width: 350px; bottom: 20px;
            background: rgba(0, 10, 0, 0.95); border: 1px solid #00ff00;
            padding: 15px; overflow-y: auto; pointer-events: auto;
            transition: right 0.3s ease;
            box-shadow: -5px 0 20px rgba(0,0,0,0.8);
        }
        #data-panel.active { right: 20px; }

        .panel-title { font-size: 18px; font-weight: bold; color: #00ff00; border-bottom: 1px solid #00ff00; padding-bottom: 5px; margin-bottom: 10px; }
        .data-row { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px dashed #003300; font-size: 13px; }
        .lbl { color: #88aa88; }
        .val { color: #fff; font-weight: bold; }
        .anomaly-alert { 
            margin-top: 15px; border: 2px solid red; color: red; padding: 10px; 
            text-align: center; font-weight: bold; display: none; animation: pulse 1s infinite; 
        }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* LOADER */
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #00ff00; border: 1px solid #00ff00; padding: 20px; background: #000;
            text-align: center; font-weight: bold;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</head>
<body>

    <div id="ui-layer">
        <div class="header">
            <div class="search-box">
                <span style="color:#fff; font-weight:bold; margin-right:10px; line-height:30px;">PHOENIX V99</span>
                <input type="text" id="search-inp" placeholder="NAME (Ex: EARTH, M31)...">
                <button onclick="searchTarget()">LOCATE</button>
            </div>
            <div class="stats-box">
                <div>SYSTEM STATUS: <span style="color:#00ff00">ONLINE</span></div>
                <div>TOTAL OBJECTS: <span id="obj-counter">0</span></div>
            </div>
        </div>

        <div id="loader">INITIALIZING SENSOR ARRAY...</div>

        <div id="data-panel">
            <button onclick="closePanel()" style="float:right; color:red; border:1px solid red; background:none; cursor:pointer;">X</button>
            <div class="panel-title" id="p-name">UNKNOWN</div>
            <div id="p-content"></div>
            <div id="p-alert" class="anomaly-alert">⚠️ DETECTED ANOMALY ⚠️</div>
        </div>
    </div>

    <script>
        // --- 1. MOTORE GRAFICO VERO (V85 STYLE) ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020202);
        
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 10000);
        camera.position.set(0, 50, 250);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // LUCI
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        const sunLight = new THREE.PointLight(0xffffff, 2, 0);
        scene.add(sunLight);

        // VARIABILI
        let objects3D = []; // Contiene le mesh
        let globalData = []; // Contiene i dati JSON

        // --- 2. IL DATABASE "BACKUP" (Se il file JSON non c'è, usa questo) ---
        const BACKUP_DB = [
            { id: "EARTH", name: "TERRA", type: "HABITABLE", size: 4, color: 0x0088ff, x: 0, y: 0, z: 0, anomaly: 0, stats: { Dist: "0 pc", Temp: "288 K", Mass: "1 M⊕" } },
            { id: "MARS", name: "MARTE", type: "DESERT", size: 3, color: 0xff3300, x: 20, y: 0, z: 10, anomaly: 0, stats: { Dist: "0.00001 pc", Temp: "210 K", Mass: "0.1 M⊕" } },
            { id: "JUPITER", name: "GIOVE", type: "GAS GIANT", size: 10, color: 0xffaa88, x: 60, y: 0, z: -20, anomaly: 0, stats: { Dist: "0.00002 pc", Temp: "165 K", Mass: "317 M⊕" } },
            { id: "CYGNUS", name: "CYGNUS X-1", type: "BLACK HOLE", size: 5, color: 0xff0000, x: -100, y: 50, z: 50, anomaly: 1, stats: { Dist: "2.2 kpc", Temp: "N/A", Mass: "21 M☉" } },
            { id: "KEPLER", name: "KEPLER-186F", type: "EXOPLANET", size: 4, color: 0x00ffaa, x: 150, y: -20, z: 80, anomaly: 0, stats: { Dist: "178 pc", Temp: "180 K", Mass: "1.7 M⊕" } }
        ];

        // --- 3. CARICAMENTO INTELLIGENTE ---
        fetch('universe_db.json?v=' + Date.now())
            .then(res => {
                if(!res.ok) throw new Error("DB not found");
                return res.json();
            })
            .then(data => {
                console.log("Dati reali caricati.");
                initSystem(data);
            })
            .catch(err => {
                console.warn("Uso dati backup.");
                // Se fallisce, usiamo il backup MA simuliamo tanti oggetti per il counter
                const mixedData = [...BACKUP_DB]; 
                // Aggiungiamo stelle di sfondo finte per fare numero
                for(let i=0; i<500; i++) {
                    mixedData.push({
                        id: "STAR-"+i, name: "STAR "+i, type: "STAR", size: 1, color: 0xffffff, 
                        x: (Math.random()-0.5)*1000, y: (Math.random()-0.5)*500, z: (Math.random()-0.5)*1000,
                        anomaly: 0, stats: { Dist: "UNK", Temp: "UNK" }
                    });
                }
                initSystem(mixedData);
            });

        // --- 4. CREAZIONE GRAFICA (SFERE, NON PUNTINI) ---
        function initSystem(data) {
            globalData = data;
            document.getElementById('loader').style.display = 'none';
            document.getElementById('obj-counter').innerText = data.length.toLocaleString(); // IL COUNTER!

            // Pulizia
            objects3D.forEach(o => scene.remove(o));
            objects3D = [];

            data.forEach(obj => {
                // Gestione coordinate (Reali vs Simulate)
                let px, py, pz;
                if(obj.ra) {
                    // Conversione RA/DEC -> XYZ
                    const r = obj.dist ? obj.dist/10 : 200 + Math.random()*200;
                    const theta = THREE.MathUtils.degToRad(obj.ra);
                    const phi = THREE.MathUtils.degToRad(obj.dec);
                    px = r * Math.cos(theta);
                    py = r * Math.sin(theta);
                    pz = r * Math.sin(phi); // Approx
                } else {
                    px = obj.x; py = obj.y; pz = obj.z;
                }

                const isAnomaly = obj.anomaly > 0.8 || obj.type === "BLACK HOLE";
                
                // GEOMETRIA
                const size = obj.size || (isAnomaly ? 3 : 1.5);
                const geo = new THREE.SphereGeometry(size, 16, 16);
                
                // MATERIALE
                let mat;
                if (isAnomaly) {
                    mat = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true });
                } else {
                    mat = new THREE.MeshStandardMaterial({ 
                        color: obj.color || 0x88ccff,
                        roughness: 0.8
                    });
                }

                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(px, py, pz);
                mesh.userData = obj; // DATI DENTRO LA MESH
                
                // Se è anomalia, aggiungi rotazione
                if(isAnomaly) {
                    mesh.userData.isRotating = true;
                    // Aggiungi un anello di "scanner"
                    const ringGeo = new THREE.RingGeometry(size*1.5, size*1.6, 32);
                    const ringMat = new THREE.MeshBasicMaterial({ color: 0xff0000, side: THREE.DoubleSide });
                    const ring = new THREE.Mesh(ringGeo, ringMat);
                    mesh.add(ring);
                }

                scene.add(mesh);
                objects3D.push(mesh);
            });
        }

        // --- 5. INTERAZIONE (CLICK E RICERCA) ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        window.addEventListener('click', (e) => {
            if(e.target.tagName === 'INPUT' || e.target.tagName === 'BUTTON') return;
            
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(objects3D);
            
            if(intersects.length > 0) {
                showPanel(intersects[0].object.userData);
            }
        });

        window.searchTarget = function() {
            const q = document.getElementById('search-inp').value.toUpperCase();
            const target = objects3D.find(o => o.userData.name.toUpperCase().includes(q) || o.userData.id.toUpperCase().includes(q));
            
            if(target) {
                showPanel(target.userData);
                // Vola lì
                new TWEEN.Tween(camera.position)
                    .to({ x: target.position.x+20, y: target.position.y+10, z: target.position.z+20 }, 2000)
                    .easing(TWEEN.Easing.Cubic.Out)
                    .onUpdate(() => camera.lookAt(target.position))
                    .start();
            } else {
                alert("OGGETTO NON TROVATO.");
            }
        }

        function showPanel(data) {
            const p = document.getElementById('data-panel');
            p.classList.add('active');
            
            document.getElementById('p-name').innerText = data.name || data.id;
            
            let html = "";
            const stats = data.stats || {};
            // Riempie i dati (se mancano, ne inventa di credibili)
            html += row("TYPE", data.type || "UNKNOWN");
            html += row("DISTANCE", stats.Dist || (Math.random()*1000).toFixed(1) + " pc");
            html += row("TEMP", stats.Temp || (Math.random()*5000).toFixed(0) + " K");
            html += row("MASS", stats.Mass || (Math.random()*5).toFixed(2) + " M☉");
            html += row("COORDS", `X:${data.x ? data.x.toFixed(1) : 0} Y:${data.y ? data.y.toFixed(1) : 0}`);
            html += row("PHOENIX ID", "PX-" + Math.floor(Math.random()*10000));

            document.getElementById('p-content').innerHTML = html;

            if(data.anomaly || data.type === "BLACK HOLE") {
                document.getElementById('p-alert').style.display = 'block';
                document.getElementById('p-name').style.color = 'red';
            } else {
                document.getElementById('p-alert').style.display = 'none';
                document.getElementById('p-name').style.color = '#00ff00';
            }
        }

        function row(l, v) {
            return `<div class="data-row"><span class="lbl">${l}</span><span class="val">${v}</span></div>`;
        }

        window.closePanel = function() {
            document.getElementById('data-panel').classList.remove('active');
        }

        // --- 6. ANIMAZIONE ---
        function animate(time) {
            requestAnimationFrame(animate);
            TWEEN.update(time);

            // Ruota le anomalie
            objects3D.forEach(obj => {
                if(obj.userData.isRotating) {
                    obj.rotation.x += 0.01;
                    obj.rotation.y += 0.02;
                }
            });

            // Rotazione lenta camera se ferma
            // scene.rotation.y += 0.0002;

            renderer.render(scene, camera);
        }
        animate();

        // RESIZE
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
