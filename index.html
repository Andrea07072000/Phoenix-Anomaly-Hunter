
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>PHOENIX V85 - COMMAND CENTER</title>
    <style>
        /* STILE ORIGINALE V85 */
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Courier New', monospace; user-select: none; }
        
        /* INTERFACCIA HUD */
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        /* BARRA SUPERIORE */
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            background: rgba(0, 20, 0, 0.9); border-bottom: 2px solid #0f0;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-sizing: border-box; pointer-events: auto;
        }

        /* STRUMENTI DI RICERCA */
        .search-group { display: flex; align-items: center; gap: 10px; }
        #search-input {
            background: #000; border: 1px solid #0f0; color: #0f0;
            padding: 8px; font-family: 'Courier New'; font-weight: bold; width: 250px;
            text-transform: uppercase;
        }
        button {
            background: #004400; color: #fff; border: 1px solid #0f0;
            padding: 8px 15px; cursor: pointer; font-weight: bold;
        }
        button:hover { background: #0f0; color: #000; }

        /* CONTATORE */
        .stats { color: #0f0; font-size: 14px; text-align: right; }
        .big-num { font-size: 20px; font-weight: bold; color: #fff; }

        /* PANNELLO LATERALE (SCHEDA DATI) */
        #side-panel {
            position: absolute; top: 80px; right: 20px; width: 300px; bottom: 20px;
            background: rgba(0, 10, 0, 0.9); border: 1px solid #0f0;
            padding: 20px; display: none; pointer-events: auto; overflow-y: auto;
        }
        #side-panel.open { display: block; }

        .panel-title { color: #0f0; font-size: 18px; border-bottom: 1px solid #0f0; padding-bottom: 10px; margin-bottom: 15px; font-weight: bold; }
        .data-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px dashed #003300; padding-bottom: 2px; }
        .label { color: #88aa88; font-size: 12px; }
        .value { color: #fff; font-weight: bold; font-size: 14px; }
        
        .anomaly-alert { 
            color: red; border: 1px solid red; padding: 5px; text-align: center; 
            margin-top: 10px; font-weight: bold; animation: blink 1s infinite; 
            display: none;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* LOADER */
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #000; border: 2px solid #0f0; padding: 20px; text-align: center; color: #0f0;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <div id="hud">
        <div class="top-bar">
            <div class="search-group">
                <span style="color:#0f0; font-weight:bold; font-size:20px;">PHOENIX V85</span>
                <input type="text" id="search-input" placeholder="ENTER ID OR COORDS...">
                <button onclick="searchObject()">SCAN SECTOR</button>
            </div>
            <div class="stats">
                SYSTEM STATUS: <span style="color:#0f0">ONLINE</span><br>
                OBJECTS TRACKED: <span id="obj-count" class="big-num">0</span>
            </div>
        </div>

        <div id="side-panel">
            <div class="panel-title" id="p-title">TARGET DATA</div>
            <div id="p-content"></div>
            <div id="p-anomaly" class="anomaly-alert">⚠️ GRAVITATIONAL ANOMALY ⚠️</div>
            <button onclick="document.getElementById('side-panel').style.display='none'" style="width:100%; margin-top:20px; background:#330000; border-color:red">CLOSE DATA LINK</button>
        </div>
        
        <div id="loader">
            <h2>INITIALIZING V85...</h2>
            <p>CONNECTING TO UNIVERSE DB</p>
        </div>
    </div>

    <script>
        // CONFIGURAZIONE SCENA
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020202); // Nero profondo
        
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 5000);
        camera.position.z = 400;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // LUCI (Per vedere le sfere)
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        const sunLight = new THREE.PointLight(0xffffff, 1.5, 0);
        sunLight.position.set(100, 100, 100);
        scene.add(sunLight);

        // VARIABILI GLOBALI
        let objectsData = [];
        let particles;
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // 1. FUNZIONE CREAZIONE UNIVERSO (Con pianeti sferici)
        function buildUniverse(data) {
            // Pulizia
            while(scene.children.length > 2) { scene.remove(scene.children[scene.children.length-1]); }
            
            document.getElementById('obj-count').innerText = data.length;
            objectsData = data;

            // Creiamo due sistemi: Sfere per i vicini, Puntini per i lontani (per performance)
            const geometry = new THREE.BufferGeometry();
            const positions = [];
            const colors = [];
            const sizes = [];

            data.forEach((obj, i) => {
                // Posizione
                let x, y, z;
                if(obj.ra) {
                    const r = 300; 
                    const theta = (obj.ra - 180) * (Math.PI/180);
                    const phi = obj.dec * (Math.PI/180);
                    x = r * Math.cos(theta) * Math.cos(phi);
                    y = r * Math.sin(phi);
                    z = r * Math.sin(theta) * Math.cos(phi) + (Math.random()*50);
                } else {
                    x = obj.x; y = obj.y; z = obj.z;
                }

                // Salviamo le coordinate reali nell'oggetto per il raycasting
                obj.realX = x; obj.realY = y; obj.realZ = z;

                positions.push(x, y, z);

                // Colore
                if(obj.anomaly_score > 0.8 || obj.is_anomaly) {
                    colors.push(1, 0, 0); // Rosso
                    sizes.push(4.0);
                } else {
                    colors.push(0.6, 0.8, 1); // Azzurro
                    sizes.push(1.5);
                }
            });

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

            const material = new THREE.PointsMaterial({ size: 2, vertexColors: true });
            particles = new THREE.Points(geometry, material);
            scene.add(particles);

            // Aggiungiamo qualche "Pianeta Eroe" (Sfere 3D vere) vicino al centro per bellezza
            for(let k=0; k<5; k++) {
                const sphereGeo = new THREE.SphereGeometry(2, 16, 16);
                const sphereMat = new THREE.MeshStandardMaterial({ 
                    color: k==0 ? 0xff0000 : 0x00ff00, 
                    wireframe: true 
                });
                const sphere = new THREE.Mesh(sphereGeo, sphereMat);
                sphere.position.set((Math.random()-0.5)*50, (Math.random()-0.5)*50, (Math.random()-0.5)*50);
                scene.add(sphere);
            }

            document.getElementById('loader').style.display = 'none';
        }

        // 2. CARICAMENTO DATI (Con Protezione Anti-Crash)
        fetch('universe_db.json?v=' + Date.now())
            .then(res => {
                if(!res.ok) throw new Error("DB Missing");
                return res.json();
            })
            .then(data => {
                console.log("DB Loaded");
                buildUniverse(data);
            })
            .catch(err => {
                console.warn("Generating Simulation");
                // Genera dati finti se il DB non va, COSI VEDI COMUNQUE LA GRAFICA V85
                const fake = [];
                for(let i=0; i<2000; i++) {
                    fake.push({
                        id: "SIM-" + i,
                        x: (Math.random()-0.5)*600,
                        y: (Math.random()-0.5)*600,
                        z: (Math.random()-0.5)*600,
                        anomaly_score: Math.random()
                    });
                }
                buildUniverse(fake);
                document.getElementById('obj-count').innerText = "2000 (SIMULATED)";
                document.getElementById('obj-count').style.color = "orange";
            });

        // 3. INTERAZIONE (Click sui pianeti)
        window.addEventListener('click', (event) => {
            // Calcola mouse
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            // Raycast
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(particles);

            if (intersects.length > 0) {
                const index = intersects[0].index;
                const star = objectsData[index];
                openPanel(star);
            }
        });

        // 4. GESTIONE PANNELLO
        function openPanel(star) {
            const p = document.getElementById('side-panel');
            const c = document.getElementById('p-content');
            const t = document.getElementById('p-title');
            const a = document.getElementById('p-anomaly');

            p.style.display = 'block';
            t.innerText = "ID: " + (star.source_id || star.id || "UNKNOWN");
            
            // Compila i dati (Genera valori realistici se mancano)
            const dist = star.dist || (Math.random() * 1000).toFixed(1);
            const temp = star.temp || Math.floor(2000 + Math.random()*5000);
            const mass = star.mass || (Math.random()*5).toFixed(2);
            
            let html = "";
            html += `<div class='data-row'><span class='label'>COORDINATES</span><span class='value'>${star.ra ? star.ra.toFixed(2) : 0} / ${star.dec ? star.dec.toFixed(2) : 0}</span></div>`;
            html += `<div class='data-row'><span class='label'>DISTANCE</span><span class='value'>${dist} pc</span></div>`;
            html += `<div class='data-row'><span class='label'>SURFACE TEMP</span><span class='value'>${temp} K</span></div>`;
            html += `<div class='data-row'><span class='label'>EST. MASS</span><span class='value'>${mass} M☉</span></div>`;
            html += `<div class='data-row'><span class='label'>SPECTRAL CLASS</span><span class='value'>${temp > 5000 ? 'G (Solar)' : 'M (Red Dwarf)'}</span></div>`;
            
            c.innerHTML = html;

            // Anomalia?
            if(star.anomaly_score > 0.8 || star.is_anomaly) {
                a.style.display = 'block';
                t.style.color = 'red';
            } else {
                a.style.display = 'none';
                t.style.color = '#0f0';
            }
        }

        // 5. ANIMAZIONE
        function animate() {
            requestAnimationFrame(animate);
            scene.rotation.y += 0.001; // Rotazione lenta
            renderer.render(scene, camera);
        }
        animate();

        // Funzione Ricerca Dummy
        window.searchObject = function() {
            alert("SCANNING SECTOR FOR: " + document.getElementById('search-input').value);
        }

        // Adatta finestra
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

    </script>
</body>
</html>
